{
  "timestamp": "2025-10-13T13:45:00Z",
  "base_url": "https://lddlzlthtwuwxxrrbxuc.supabase.co/functions/v1",
  "description": "Smoke tests pour l'API d'authentification et gestion de sessions",
  "tests": [
    {
      "name": "login",
      "status": "READY",
      "description": "POST /auth-sessions/login - Création de session + cookies",
      "expected_behavior": [
        "Crée row dans public.sessions",
        "Crée row token_hash dans public.refresh_tokens",
        "Set cookies: access_token (HttpOnly), refresh_token (HttpOnly), session_id",
        "Retourne session_id et user info"
      ],
      "curl_example": "curl -c cookies.txt -X POST https://lddlzlthtwuwxxrrbxuc.supabase.co/functions/v1/auth-sessions/login -H 'Content-Type: application/json' -d '{\"email\":\"test@example.com\",\"password\":\"pass123\",\"device\":\"web\"}'"
    },
    {
      "name": "session_info",
      "status": "READY",
      "description": "GET /auth-sessions/session-info - Lecture info session depuis cookie",
      "expected_behavior": [
        "Lit session_id depuis cookie",
        "Retourne metadata session (user_id, roles, device, ip, etc.)"
      ],
      "curl_example": "curl -b cookies.txt https://lddlzlthtwuwxxrrbxuc.supabase.co/functions/v1/auth-sessions/session-info"
    },
    {
      "name": "refresh",
      "status": "READY",
      "description": "POST /auth-sessions/refresh - Rotation single-use refresh token",
      "expected_behavior": [
        "Vérifie hash du refresh_token cookie",
        "Révoque ancien token (revoked=true)",
        "Crée nouveau refresh_token + hash",
        "Génère nouveau JWT access_token",
        "Set nouveaux cookies"
      ],
      "curl_example": "curl -b cookies.txt -c cookies.txt -X POST https://lddlzlthtwuwxxrrbxuc.supabase.co/functions/v1/auth-sessions/refresh"
    },
    {
      "name": "logout",
      "status": "READY",
      "description": "POST /auth-sessions/logout - Révocation session + clear cookies",
      "expected_behavior": [
        "Révoque session (sessions.revoked=true)",
        "Révoque tous refresh_tokens de la session",
        "Clear tous les cookies",
        "Log audit event"
      ],
      "curl_example": "curl -b cookies.txt -c cookies.txt -X POST https://lddlzlthtwuwxxrrbxuc.supabase.co/functions/v1/auth-sessions/logout"
    },
    {
      "name": "verify_revoked",
      "status": "READY",
      "description": "Vérification que session révoquée ne peut plus être utilisée",
      "expected_behavior": [
        "Tentative d'accès à session-info avec session révoquée",
        "Doit retourner 401 Unauthorized"
      ]
    }
  ],
  "database_samples": {
    "sessions_table_example": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "user_id": "123e4567-e89b-12d3-a456-426614174000",
      "tenant_id": "789e4567-e89b-12d3-a456-426614174001",
      "roles": ["family"],
      "device": "web",
      "ip": "192.168.1.1",
      "created_at": "2025-10-13T13:30:00Z",
      "last_seen_at": "2025-10-13T13:35:00Z",
      "revoked": false,
      "mfa_verified": false,
      "access_jti": null
    },
    "refresh_tokens_table_example": {
      "id": "660e8400-e29b-41d4-a716-446655440001",
      "session_id": "550e8400-e29b-41d4-a716-446655440000",
      "token_hash": "a3c8f5e2d1b4a9c7e6f3d2b1a0c9e8f7d6b5a4c3e2f1d0c9b8a7e6f5d4c3b2a1",
      "expires_at": "2025-10-27T13:30:00Z",
      "revoked": false,
      "created_at": "2025-10-13T13:30:00Z"
    },
    "audit_logs_table_example": {
      "id": "770e8400-e29b-41d4-a716-446655440002",
      "user_id": "123e4567-e89b-12d3-a456-426614174000",
      "action": "login",
      "resource_type": "session",
      "resource_id": "550e8400-e29b-41d4-a716-446655440000",
      "metadata": {
        "device": "web",
        "ip": "192.168.1.1"
      },
      "ip_address": "192.168.1.1",
      "user_agent": "Mozilla/5.0...",
      "created_at": "2025-10-13T13:30:00Z"
    }
  },
  "security_notes": {
    "service_role_usage": [
      "La clé service_role est utilisée UNIQUEMENT dans les Edge Functions (backend)",
      "Jamais exposée au client (frontend)",
      "Utilisée pour les écritures dans sessions et refresh_tokens",
      "Utilisée pour bypass RLS lors de l'insertion des tokens"
    ],
    "token_security": [
      "Refresh tokens stockés en hash SHA-256 uniquement",
      "Tokens bruts JAMAIS en base de données",
      "Rotation single-use: ancien token révoqué lors du refresh",
      "Access token JWT signé avec clé secrète"
    ],
    "cookie_security": [
      "HttpOnly: protège contre XSS",
      "Secure: HTTPS uniquement",
      "SameSite=Lax: protection CSRF (Strict pour admin)",
      "TTL: 15min (access), 14 jours (refresh)"
    ]
  },
  "mfa_implementation": {
    "status": "STUB_IMPLEMENTED",
    "description": "MFA obligatoire pour roles admin (superadmin, territory_admin)",
    "current_behavior": "Flag mfa_verified stocké en session, check MFA settings lors du login",
    "todo": "Implémenter TOTP/WebAuthn challenge complet"
  },
  "execution_instructions": {
    "1_setup": "Créer un user test avec: curl POST /auth/signup ou via Supabase Auth UI",
    "2_run_tests": "chmod +x outputs/smoke-tests.sh && ./outputs/smoke-tests.sh",
    "3_verify_db": "Se connecter à Supabase et vérifier les tables sessions, refresh_tokens, audit_logs",
    "4_check_report": "cat outputs/smoke_report_sessions.json"
  },
  "summary": {
    "status": "IMPLEMENTATION_COMPLETE",
    "total_endpoints": 5,
    "implemented": 5,
    "pending": 0,
    "note": "Tous les endpoints sont implémentés et prêts pour les tests"
  }
}
